import os
import argparse
import yara
from scanner.scan import MalwareExtractor


if __name__ == 'main':
	parser = argparse.ArgumentParser()
	parser.add_argument('-rd', '--root_directory', help='Root directory to be scanned.')
	parser.add_argument('-yf', '--yara_rules', help='Compiled Yara rules file. Provide full path. Compiled file will be stored in rules directory.')
	parser.add_argument('-yd', '--yara_directory', help='Directory with Yar rules to be compiled. Output will be stored in output directory.')
	parser.add_argument('-fs', '--file_to_scan', help='Single file to be scanned. Provide full path.')

	args = parser.parse_args()

	if args.yara_directory:
		assert os.path.isdir(args.yara_directory)
		MalwareExtractor.compile_yara_rules(args.yara_directory)
		print("Yara rules compilation completed.")

	elif args.file_to_scan and args.yara_rules:
		assert os.path.isfile(args.file_to_scan)
		assert os.path.isfile(args.yara_rules)
		rules = yara.load(args.yara_rules)
		MalwareExtractor.scan_file(args.file_to_scan, rules)
		print("File scan completed.")

	elif args.root_directory and args.yara_rules:
		extractor = MalwareExtractor(args.root_directory, args.yara_rules)
		matches = extractor.scan_directory_struct()
