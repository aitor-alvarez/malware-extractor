import os
import yara

def compile_yara_rules(directory):
	direct = os.listdir(directory)
	yara_dict ={}
	for yar in direct:
		try:
			#Try to compile individual rules for correctness
			test = yara.compile(filepath=directory+yar)
			yara_dict[yar] = directory+yar
		except:
			continue
	rules = yara.compile(sources=yara_dict)
	rules.save('rules/yara_rules')
	return None


#Scan from directory root down in search for compromised files
def scan_directory_struct(root_dir, exclude_paths, yara_rules_file):
	assert os.path.isdir(root_dir)
	matches=[]
	rules = yara.load(yara_rules_file)
	for root, dirs, files in os.walk(root_dir):
		for fil in files:
			print(os.path.join(root, fil))
			match = rules.match(os.path.join(root, dir, fil))
			matches.append({'file': os.path.join(root, dir, fil), 'match': match})
	return matches







