import os
import yara
from scanner.extract_info import FileExtract


class MalwareExtractor:
	def __int__(self, root_dir, yara_rules_file):
		self.root_dir = root_dir
		self.yara_rules_file = yara_rules_file
		self.rules = yara.load(self.yara_rules_file)


	@staticmethod
	def compile_yara_rules(yara_directory):
		if os.path.isdir(yara_directory):
			direct = os.listdir(yara_directory)
			yara_dict = {}
			for yar in direct:
				try:
					# Try to compile individual rules for correctness
					test = yara.compile(filepath=yara_directory + yar)
					yara_dict[yar] = yara_directory + yar
				except yara.SyntaxError as e:
					print(e)
					continue
			rules = yara.compile(filepaths=yara_dict)
			rules.save('rules/yara_rules')
			return None
		else:
			print("No compiled yara file was provided")

	# Scan from directory root down in search for compromised files
	def scan_directory_struct(self):
		assert os.path.isdir(self.root_dir)
		matches_list = []
		rules = yara.load(self.yara_rules_file)
		for root, dirs, files in os.walk(self.root_dir):
			for fil in files:
				match = rules.match(os.path.join(root, dir, fil))
				if match:
					print(f"Malicious file found at {match['file']}")
					matches_list.append({'file': os.path.join(root, dir, fil), 'matches': match})
		return matches_list


	@staticmethod
	def scan_file(file_to_scan, yara_rules):
		assert os.path.isfile(file_to_scan)
		match = yara_rules(file_to_scan)
		if match:
			print(f"Compromised file {match['file']}")
			return [{'file': file_to_scan, 'match': match}]
		else:
			return None


	@staticmethod
	def extract_info_from_files(matches):
		extracted=[]
		for match in matches:
			data = FileExtract.get_info(match['file'])
			extracted.append({'file': match['file'], 'match': match['match'], 'data': data})
		return extracted


	@staticmethod
	def extract_info_from_file(match):
		data = FileExtract.get_info(match['file'])
		output = {'file': match['file'], 'match': match['match'], 'data': data}
		return output
