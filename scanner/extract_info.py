import lief
from macholibre import parse
import telfhash
from simple_file_checksum import get_checksum

lief.logging.disable()

#Extract static data from binaries
class FileExtract:

	@staticmethod
	def get_info(file_data):
		try:
			if lief.is_pe(file_data):
				resources=[]
				hashes ={}
				headers={}
				sections={}
				symbols={}
				pe_file = lief.PE.parse(file_data)
				hashes['imphash'] = lief.PE.get_imphash(pe_file)
				hashes['md5'] = pe_file.authentihash_md5.hex()
				hashes['sha-1'] = pe_file.authentihash_sha1.hex()
				hashes['sha-256'] = pe_file.authentihash_sha256.hex()
				headers['type'] = "PE"
				headers['magic'] = "PE32" if pe_file.optional_header.magic == lief.PE.PE_TYPE.PE32 else "PE64"
				headers['machine'] = str(pe_file.header.machine)
				headers['time_stamp'] = pe_file.header.time_date_stamps

				if pe_file.sections.__len__()>0:
					i=1
					for section in pe_file.sections:
						key = 'section_name_'+str(i)
						sections[key] = section.name
						i+=1

				if pe_file.has_imports:
					for entry in pe_file.imports:
						entries={'type': 'imports','dll': entry.name}
						imports=[]
						for impor in entry.entries:
							imports.append(impor.name)
						entries['imports'] = imports
						resources.append(entries)
				if len(pe_file.symbols)>0:
					output_symbols=[]
					for symbol in symbols:
						if symbol.section_number >0:
							symbols['symbol'] = symbol.section.name
							output_symbols.append(symbols)
				return [headers, hashes, sections, resources, output_symbols]

			elif lief.is_elf(file_data):
				elf_file = lief.ELF.parse(file_data)
				header = elf_file.header
				headers = {}
				hashes= {}
				libraries = {}
				headers['machine'] = str(header.machine_type)
				headers['type'] = "ELF"
				hashes['md5'] = get_checksum(file_data, algorithm='MD5')
				hashes['sha-1'] = get_checksum(file_data, algorithm='SHA1')
				hashes['sha-256'] = get_checksum(file_data, algorithm='SHA256')
				hashes['telfhash'] = telfhash.telfhash(file_data)[0]['telfhash']

				#Segments
				segments = elf_file.segments
				if len(segments) > 0:
					output_segments=[]
					for segment in segments:
						segments_output = {}
						sects = segment.sections
						scts = ", ".join([section.name for section in sects])
						flags_str = ["-"] * 3
						if lief.ELF.SEGMENT_FLAGS.R in segment:
							flags_str[0] = "r"

						if lief.ELF.SEGMENT_FLAGS.W in segment:
							flags_str[1] = "w"

						if lief.ELF.SEGMENT_FLAGS.X in segment:
							flags_str[2] = "x"
						flags_str = "".join(flags_str)

						segments_output['type'] = str(segment.type).split(".")[-1]
						segments_output['flags'] = flags_str
						segments_output['sections'] = scts
						output_segments.append(segments_output)

				#Libraries
				libraries['libraries'] = elf_file.libraries

				#Sections details
				output_sections=[]
				for section in elf_file.sections:
					sections = {}
					if section.name !='':
						sections[section.name] = [str(section.type).split(".")[-1], abs(section.entropy),
						                          " - ".join([str(s.type).split(".")[-1] for s in section.segments])]
						output_sections.append(sections)
				#Symbols
				symbols = elf_file.exported_symbols
				output_symbols=[]
				if len(symbols)>0:
					for symbol in symbols:
						symbols_output={}
						import_export = ""
						if symbol.imported:
							import_export = "I"

						if symbol.exported:
							import_export = "E"

						symbols_output['name'] = symbol.name
						symbols_output['type'] = str(symbol.type).split(".")[-1]
						symbols_output['import_export'] = import_export
						output_symbols.append(symbols_output)

				return [headers, hashes, output_segments, libraries, output_sections, output_symbols]


			elif lief.is_macho(file_data):
				machO_file = parse(file_data)
				headers = {}
				hashes = {}
				imports = {}
				headers['machine'] = machO_file['macho']['cputype']
				headers['type'] = "MACH-O"
				headers['filetype'] = machO_file['macho']['filetype']
				headers['subtype'] = machO_file['macho']['subtype']
				hashes['md5'] = machO_file['hashes']['md5']
				hashes['sha-1'] = machO_file['hashes']['sha1']
				hashes['sha-256'] = machO_file['hashes']['sha256']
				imports['imports'] = machO_file['macho']['imports']
				return [headers, hashes, imports]

			elif lief.is_dex(file_data):
				dex = lief.DEX.parse(file_data)
				headers = {}
				hashes = {}
				classes = {}
				methods={}
				strings={}
				headers['type'] = "DEX"
				hashes['md5'] = get_checksum(file_data, algorithm='MD5')
				hashes['sha-1'] = get_checksum(file_data, algorithm='SHA1')
				hashes['sha-256'] = get_checksum(file_data, algorithm='SHA256')
				classes['classes'] = [c.name for c in dex.classes]
				methods['methods'] = [m.name for m in dex.methods]
				return [headers, hashes, classes, methods]

		except:
			print(f"The file {file_data} may be corrupted or contain errors")